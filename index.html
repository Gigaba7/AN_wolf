<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>アークナイツ人狼 GMツール</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
    <!-- favicon.ico 404回避（データURI） -->
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23050712'/%3E%3Cpath d='M18 18h8l6 18 6-18h8L38 46h-12L18 18z' fill='%23f5f5f7'/%3E%3C/svg%3E"
    />
  </head>
  <body class="opaque-bg">
    <div id="app">
      <!-- ホーム画面 -->
      <section id="home-screen" class="screen active">
        <header class="app-header">
          <h1>アークナイツ人狼 GMツール</h1>
          <p class="subtitle">☆3以下限定・レユニオン人狼 用ファンメイド支援ツール</p>
        </header>

        <main class="home-layout">
          <section class="home-card">
            <h2>ルーム</h2>
            <div class="mode-selection" style="display: flex; gap: 8px; margin-bottom: 12px;">
              <button id="btn-create-room" class="btn primary">ルーム作成</button>
              <button id="btn-join-room" class="btn secondary">ルーム参加</button>
            </div>
            <div id="room-info" class="room-info" style="display: none; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <p style="margin: 0 0 12px 0; font-size: 14px; color: #a0a4ba;">ルームID</p>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <strong id="room-id-display" style="font-family: monospace; font-size: 24px; letter-spacing: 0.1em; color: #f5f5f7; flex: 1; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;"></strong>
              </div>
              <button id="btn-copy-room-id" class="btn ghost small" style="width: 100%;">ルームIDをコピー</button>
              <p style="margin: 12px 0 0 0; font-size: 12px; color: #a0a4ba; text-align: center;">このルームIDを参加者に共有してください</p>
            </div>
            <div id="create-room-form" class="create-room-form" style="display: none; margin-top: 12px;">
              <div style="display:flex; justify-content:center; margin-bottom: 10px;">
                <label class="player-avatar-input" id="host-avatar-label" title="アイコン画像をアップロード">
                  <span id="host-avatar-letter">?</span>
                  <img id="host-avatar-preview" class="avatar-preview hidden" alt="host avatar preview" />
                  <input type="file" id="host-avatar-file" accept="image/*" />
                </label>
              </div>
              <input type="text" id="host-name-input" placeholder="あなたの名前を入力" class="host-name-input" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-align: center;" />
              <button id="btn-create-room-confirm" class="btn primary" style="width: 100%;">ルーム作成</button>
            </div>
            <div id="join-room-form" class="join-room-form" style="display: none; margin-top: 12px;">
              <div style="display:flex; justify-content:center; margin-bottom: 10px;">
                <label class="player-avatar-input" id="player-avatar-label" title="アイコン画像をアップロード">
                  <span id="player-avatar-letter">?</span>
                  <img id="player-avatar-preview" class="avatar-preview hidden" alt="player avatar preview" />
                  <input type="file" id="player-avatar-file" accept="image/*" />
                </label>
              </div>
              <input type="text" id="room-id-input" placeholder="ルームIDを入力（6文字）" class="room-id-input" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-transform: uppercase; text-align: center; letter-spacing: 0.1em;" maxlength="6" />
              <input type="text" id="player-name-input" placeholder="あなたの名前を入力" class="player-name-input" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-align: center;" />
              <button id="btn-join-room-confirm" class="btn primary" style="width: 100%;">参加</button>
            </div>
          </section>

          <section class="home-card">
            <h2>ルール説明動画</h2>
            <div class="video-wrapper">
              <!-- 利用者が差し替え想定のダミー埋め込み -->
              <iframe
                src="https://www.youtube.com/embed/dQw4w9WgXcQ"
                title="ルール説明動画"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
            <div class="home-links">
              <button id="open-options" class="btn ghost">オプション</button>
              <button id="open-tos" class="btn ghost">利用規約</button>
            </div>
          </section>

          <section class="home-card disclaimer-card">
            <h2>注意事項</h2>
            <ul>
              <li>本ツールは個人が制作した <strong>非公式ファンツール</strong> です。</li>
              <li>Hypergryph / Yostar とは一切関係ありません。</li>
              <li>利用は<strong>自己責任</strong>でお願いします。</li>
              <li style="margin-top: 8px; color: #a0a4ba; font-size: 12px;">配信の演出上GMアリで作成していますが、そのうちもっと遊びやすいようにGMナシ版の作成も検討中なので許してちょんまげ</li>
            </ul>
            <button id="start-game" class="btn primary start-btn" style="display: none;">ゲーム開始</button>
          </section>
        </main>
      </section>

      <!-- 待機画面 -->
      <section id="waiting-screen" class="screen">
        <div class="waiting-layout">
          <div class="waiting-content">
            <h1 class="waiting-title">ルーム待機中</h1>
            <p class="waiting-subtitle">参加者を待っています...</p>
            
            <div class="waiting-room-id-section">
              <p class="waiting-label">ルームID</p>
              <div class="waiting-room-id-display">
                <strong id="waiting-room-id" class="waiting-room-id-text"></strong>
                <button id="btn-copy-waiting-room-id" class="btn ghost small">コピー</button>
              </div>
              <p class="waiting-hint">このルームIDを参加者に共有してください</p>
            </div>
            
            <div class="waiting-players-section">
              <h2 class="waiting-section-title">参加者 (<span id="waiting-players-count">1</span>人)</h2>
              <div id="waiting-players-list" class="waiting-players-list">
                <!-- JSで参加者を描画 -->
              </div>
            </div>
            
            <div class="waiting-actions">
              <button id="btn-start-game-from-waiting" class="btn primary" disabled>
                ゲーム開始 (最低3人必要)
              </button>
              <button id="btn-leave-room" class="btn ghost">ルームを退出</button>
            </div>
          </div>
        </div>
      </section>

      <!-- メイン GM 画面 -->
      <section id="main-screen" class="screen">
        <div class="main-layout">
          <!-- ④ プレーヤー表示 -->
          <aside class="panel players-panel">
            <h2>プレイヤー</h2>
            <div id="players-list" class="players-list">
              <!-- JSでプレイヤーを描画 -->
            </div>
          </aside>

          <!-- 中央メインエリア -->
          <section class="panel center-panel">
            <!-- ① 状態表示 -->
            <div class="status-bar">
              <div class="status-main">
                <div class="status-main-item">
                  <span class="status-main-label">ターン</span>
                  <span id="status-turn" class="status-main-value">1 / 5</span>
                </div>
                <div class="status-main-item">
                  <span class="status-main-label">進行状況</span>
                  <span id="status-stars" class="status-main-stars">☆☆☆☆☆</span>
                </div>
                <div class="status-main-item">
                  <span class="status-main-label">ステージ</span>
                  <span id="status-stage" class="status-main-value status-stage-value">未選出</span>
                </div>
                <div class="status-main-item" id="status-wolf-cost-item" style="display: none;">
                  <span class="status-main-label">妨害コスト</span>
                  <span id="status-wolf-cost" class="status-main-value">-</span>
                </div>
                <div class="status-main-item" id="status-doctor-punch-item" style="display: none;">
                  <span class="status-main-label">神拳発動</span>
                  <span id="status-doctor-punch" class="status-main-value">-</span>
                </div>
              </div>
              <button id="main-options-btn" class="icon-button" title="オプション">
                ⚙
              </button>
            </div>
            
            <!-- プレイ映像用 16:9 透明エリア（背景レイヤー） -->
            <div class="play-video-wrapper">
              <div class="play-video-area">
              </div>
            </div>

            <!-- UI要素（前面レイヤー） -->
            <div class="center-ui-content">
              <!-- ③ ログエリア -->
              <div class="log-panel">
                <div id="log-list" class="log-list"></div>
              </div>
            </div>
          </section>

          <!-- ② 操作パネル -->
          <aside class="panel control-panel">
            <h2>操作</h2>
            <div class="control-group">
              <!-- 次のプレイヤーは自動進行のため削除 -->
            </div>
            <div class="control-group">
              <button id="btn-success" class="btn success wide">
                成功
              </button>
              <button id="btn-fail" class="btn danger wide">
                失敗
              </button>
            </div>
          </aside>
        </div>

        <!-- フッターのクレジット -->
        <footer class="app-footer">
          <p>
            本ツールは非公式ファンツールです。Hypergryph / Yostar とは一切関係ありません。
          </p>
        </footer>
      </section>

      <!-- 参加者画面（最小UI：役職ボタンのみ / 画面表示エリアなし） -->
      <section id="participant-screen" class="screen">
        <div class="participant-layout">
          <div class="participant-content">
            <h1 class="participant-title">参加者用操作</h1>
            <p class="participant-subtitle">GMの画面共有を見ながら進行してください</p>

            <!-- 役職表示 -->
            <div id="participant-role-display" class="participant-role-display" style="display: none;">
              <span class="participant-role-label">役職:</span>
              <span id="participant-role-text" class="participant-role-text">-</span>
            </div>

            <!-- コスト表示（人狼のみ） -->
            <div id="participant-cost-display" class="participant-cost-display" style="display: none;">
              <span class="participant-cost-label">Cost:</span>
              <span id="participant-cost-value" class="participant-cost-value">-</span>
            </div>

            <div class="participant-actions">
              <button id="btn-wolf-action" class="btn warning wide">
                人狼妨害
              </button>
              <button id="btn-doctor-punch" class="btn info wide">
                ドクター神拳
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- ステージルーレットポップアップ -->
      <div id="stage-roulette-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>ステージルーレット</h2>
          <p class="modal-subtitle">
            設定された範囲からランダムにステージを選出します。
          </p>
          <div id="stage-roulette-items" class="roulette-list">
            <!-- JSで候補を表示 -->
          </div>
        </div>
      </div>

      <!-- 妨害選択ポップアップ（人狼用） -->
      <div id="wolf-action-select-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>人狼妨害選択</h2>
          <p class="modal-subtitle">
            発動する妨害を選択してください（コスト: <span id="wolf-cost-display">-</span>）
          </p>
          <div id="wolf-action-list" class="wolf-action-list">
            <!-- JSで妨害リストを表示 -->
          </div>
          <div class="modal-actions">
            <button data-close-modal="wolf-action-select-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- GM向け：妨害発動通知ポップアップ -->
      <div id="gm-wolf-action-notification-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>妨害発動</h2>
          <p id="gm-wolf-action-text" class="result-summary" style="text-align: center; font-size: 20px; margin-top: 12px;">
            （取得中…）
          </p>
          <div class="modal-actions">
            <button id="gm-wolf-action-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- GM向け：職業ルーレットポップアップ（ランダム職業使用禁止用） -->
      <div id="job-roulette-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>職業ルーレット</h2>
          <p class="modal-subtitle">
            ランダム職業使用禁止：使用禁止になる職業を選出します。
          </p>
          <div id="job-roulette-items" class="roulette-list">
            <!-- JSで候補を表示 -->
          </div>
          <div class="modal-actions">
            <button id="job-roulette-start" class="btn primary">
              ルーレット開始
            </button>
            <button data-close-modal="job-roulette-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 人狼妨害の使用確認（手番開始フェーズ） -->
      <div id="wolf-decision-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>人狼妨害</h2>
          <p class="modal-subtitle">
            手番のはじめに妨害を使用しますか？
          </p>
          <div class="modal-actions">
            <button id="wolf-decision-use" class="btn warning">使用する</button>
            <button id="wolf-decision-skip" class="btn ghost">使用しない</button>
          </div>
        </div>
      </div>

      <!-- GM向けアナウンス（参加者に見せない） -->
      <div id="gm-announcement-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>アナウンス</h2>
          <p class="modal-subtitle">
            この次の画面は参加者が閲覧できないようにしてください。（OBSの表示を一時的に隠す等）
          </p>
          <div class="modal-actions">
            <button id="gm-announcement-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- GM向け：全員の役職一覧 -->
      <div id="gm-roles-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <h2>役職一覧（GM専用）</h2>
          <p class="modal-subtitle">ゲーム開始時に割り当てられた役職を周知します。</p>
          <div id="gm-roles-list" class="role-confirmation-list"></div>
          <div class="modal-actions">
            <button id="gm-roles-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- オプションポップアップ -->
      <div id="options-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <h2>オプション</h2>
          <section class="options-section">
            <h3>サウンド</h3>
            <label class="toggle">
              <input type="checkbox" id="opt-sound" />
              <span>効果音を有効にする (デフォルトOFF)</span>
            </label>
          </section>

          <section class="options-section">
            <h3>ゲーム設定</h3>
            <div class="options-row">
              <label>
                対象ステージ範囲 (章)
                <div class="inline-inputs">
                  <select id="opt-stage-min">
                    <option value="2">2章</option>
                    <option value="3">3章</option>
                    <option value="4">4章</option>
                    <option value="5">5章</option>
                  </select>
                  <span>〜</span>
                  <select id="opt-stage-max">
                    <option value="2">2章</option>
                    <option value="3" selected>3章</option>
                    <option value="4">4章</option>
                    <option value="5">5章</option>
                  </select>
                </div>
              </label>
            </div>

            <div class="options-row">
              <label>
                人狼妨害カスタム (1行につき1項目)
                <textarea
                  id="opt-wolf-actions"
                  rows="5"
                  placeholder="例：&#10;編成人数10人&#10;強襲ステージ&#10;推し+☆2以下編成&#10;ドクター神拳使用不可"
                ></textarea>
              </label>
            </div>

            <button id="opt-back-home" class="btn ghost small">
              ホーム画面に戻る
            </button>
          </section>

          <section class="options-section">
            <h3>利用規約</h3>
            <p>
              詳細な注意事項は
              <button id="opt-open-tos" class="link-button">
                利用規約ページ
              </button>
              をご確認ください。
            </p>
          </section>

          <div class="modal-actions">
            <button id="opt-save" class="btn primary">保存</button>
            <button data-close-modal="options-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 利用規約ポップアップ -->
      <div id="tos-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide scrollable">
          <h2>利用規約 / 免責事項</h2>
          <div class="tos-body">
            <p>
              本ツールは個人が制作した<strong>非公式ファンツール</strong>です。<br />
              Hypergryph / Yostar とは一切関係ありません。
            </p>
            <ul>
              <li>
                本ツールの利用は<strong>自己責任</strong>でお願いいたします。利用により発生したいかなる損害についても制作者は責任を負いません。
              </li>
              <li>
                ゲーム画面・キャラクター・名称等の権利は各権利者に帰属します。
              </li>
              <li>
                本ツールは画像・テキストなどのデータ取得は行っていませんが、データの取り扱いには十分ご注意ください。
              </li>
              <li>
                配信・動画での使用は自由ですが、公式と誤認されない形でご利用ください。
              </li>
            </ul>
            <p>
              詳細なガイドラインや二次創作ポリシーについては、各公式サイトの規約をご確認ください。
            </p>
          </div>
          <div class="modal-actions">
            <button data-close-modal="tos-modal" class="btn primary">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 役職確認モーダル（ゲーム開始前） -->
      <div id="role-confirmation-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <h2>役職確認</h2>
          <p class="modal-subtitle">
            役職がランダムに割り当てられました。確認してからゲームを開始してください。
          </p>
          <div id="role-confirmation-list" class="role-confirmation-list">
            <!-- JSで役職リストを生成 -->
          </div>
          <div class="modal-actions">
            <button id="role-confirmation-start" class="btn primary">ゲーム開始</button>
          </div>
        </div>
      </div>

      <!-- 自分の役職確認モーダル（ゲーム開始時） -->
      <div id="self-role-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>あなたの役職</h2>
          <p id="self-role-text" class="result-summary" style="text-align: center; font-size: 20px; margin-top: 12px;">
            （取得中…）
          </p>
          <p id="self-role-waiting" class="result-summary hidden" style="text-align:center; margin-top: 10px; color:#a0a4ba;">
            開始待機中…
          </p>
          <div class="modal-actions">
            <button id="self-role-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- 勝敗結果ポップアップ -->
      <div id="result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2 id="result-title">結果</h2>
          <p id="result-summary" class="result-summary"></p>
          <div id="result-extra" class="result-extra"></div>
          <div id="result-roles" class="result-roles"></div>
          <div class="modal-actions">
            <button id="result-reset" class="btn primary">リセットして終了</button>
            <button data-close-modal="result-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase設定とモジュール（ES Modules） -->
    <script type="module" src="./firebase-config.js"></script>
    <script type="module" src="./firebase-auth.js"></script>
    <script type="module" src="./firebase-db.js"></script>
    <script type="module" src="./firebase-sync.js"></script>
    
    <!-- メインロジック -->
    <script type="module" src="./main.js"></script>
  </body>
  </html>

