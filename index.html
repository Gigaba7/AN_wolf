<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>アークナイツ人狼 GMツール</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
    <!-- favicon.ico 404回避（データURI） -->
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23050712'/%3E%3Cpath d='M18 18h8l6 18 6-18h8L38 46h-12L18 18z' fill='%23f5f5f7'/%3E%3C/svg%3E"
    />
  </head>
  <body class="opaque-bg">
    <div id="app">
      <!-- ホーム画面 -->
      <section id="home-screen" class="screen active">
        <header class="app-header">
          <h1>アークナイツ人狼 GMツール</h1>
          <p class="subtitle">レユニオン人狼 用ファンメイド支援ツール</p>
        </header>

        <main class="home-layout">
          <section class="home-card">
            <h2>ルーム</h2>
            <div class="mode-selection" style="display: flex; gap: 8px; margin-bottom: 12px;">
              <button id="btn-create-room" class="btn primary">ルーム作成</button>
              <button id="btn-join-room" class="btn secondary">ルーム参加</button>
            </div>
            <div id="room-info" class="room-info" style="display: none; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <p style="margin: 0 0 12px 0; font-size: 14px; color: #a0a4ba;">ルームID</p>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <strong id="room-id-display" style="font-family: monospace; font-size: 24px; letter-spacing: 0.1em; color: #f5f5f7; flex: 1; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;"></strong>
              </div>
              <button id="btn-copy-room-id" class="btn ghost small" style="width: 100%;">ルームIDをコピー</button>
              <p style="margin: 12px 0 0 0; font-size: 12px; color: #a0a4ba; text-align: center;">このルームIDを参加者に共有してください</p>
            </div>
            <div id="create-room-form" class="create-room-form" style="display: none; margin-top: 12px;">
              <div style="display:flex; justify-content:center; margin-bottom: 10px;">
                <label class="player-avatar-input" id="host-avatar-label" title="アイコン画像をアップロード">
                  <span id="host-avatar-letter">?</span>
                  <img id="host-avatar-preview" class="avatar-preview hidden" alt="host avatar preview" />
                  <input type="file" id="host-avatar-file" name="host-avatar-file" accept="image/*" />
                </label>
              </div>
              <input type="text" id="host-name-input" name="host-name" placeholder="あなたの名前を入力" class="host-name-input" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-align: center;" />
              <button id="btn-create-room-confirm" class="btn primary" style="width: 100%;">ルーム作成</button>
            </div>
            <div id="join-room-form" class="join-room-form" style="display: none; margin-top: 12px;">
              <div style="display:flex; justify-content:center; margin-bottom: 10px;">
                <label class="player-avatar-input" id="player-avatar-label" title="アイコン画像をアップロード">
                  <span id="player-avatar-letter">?</span>
                  <img id="player-avatar-preview" class="avatar-preview hidden" alt="player avatar preview" />
                  <input type="file" id="player-avatar-file" name="player-avatar-file" accept="image/*" />
                </label>
              </div>
              <div style="position: relative; width: 100%;">
                <input type="password" id="room-id-input" name="room-id" placeholder="ルームIDを入力（6文字）" class="room-id-input" style="width: 100%; padding: 8px 40px 8px 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-transform: uppercase; text-align: center; letter-spacing: 0.1em;" maxlength="6" />
                <button type="button" id="toggle-room-id-visibility" class="toggle-password-btn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #a0a4ba; cursor: pointer; font-size: 18px; padding: 4px;">👁</button>
              </div>
              <input type="text" id="player-name-input" name="player-name" placeholder="あなたの名前を入力" class="player-name-input" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px; text-align: center;" />
              <button id="btn-join-room-confirm" class="btn primary" style="width: 100%;">参加</button>
            </div>
          </section>

          <section class="home-card">
            <h2>ルール説明動画</h2>
            <div class="video-wrapper">
              <!-- 利用者が差し替え想定のダミー埋め込み -->
              <iframe
                src="https://www.youtube.com/embed/dQw4w9WgXcQ"
                title="ルール説明動画"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
            <div class="home-links">
              <button id="open-rulebook" class="btn ghost">ルールブック</button>
              <button id="open-options" class="btn ghost">オプション</button>
              <button id="open-tos" class="btn ghost">利用規約</button>
            </div>
          </section>

          <section class="home-card disclaimer-card">
            <h2>注意事項</h2>
            <ul>
              <li>本ツールは個人が制作した <strong>非公式ファンツール</strong> です。</li>
              <li>Hypergryph / Yostar とは一切関係ありません。</li>
              <li>利用は<strong>自己責任</strong>でお願いします。</li>
              <li style="margin-top: 8px; color: #a0a4ba; font-size: 12px;">配信の演出上GMアリで作成していますが、そのうちもっと遊びやすいようにGMナシ版の作成も検討中なので許してちょんまげ</li>
            </ul>
            <p style="margin-top: 16px; color: #a0a4ba; font-size: 12px; text-align: center;">
              バグ報告・修正要望などは作成者の<a href="https://x.com/GiGaBa_7" id="bug-report-link" target="_blank" rel="noopener noreferrer" style="color: #8be6c3; text-decoration: underline;">DM</a>まで！
            </p>
            <button id="start-game" class="btn primary start-btn" style="display: none;">ゲーム開始</button>
          </section>
        </main>
      </section>

      <!-- 待機画面 -->
      <section id="waiting-screen" class="screen">
        <div class="waiting-layout">
          <div class="waiting-content">
            <h1 class="waiting-title">ルーム待機中</h1>
            <p class="waiting-subtitle">参加者を待っています...</p>
            
            <div class="waiting-room-id-section">
              <p class="waiting-label">ルームID</p>
              <div class="waiting-room-id-display">
                <strong id="waiting-room-id" class="waiting-room-id-text"></strong>
                <button type="button" id="toggle-waiting-room-id-visibility" class="toggle-password-btn" style="background: none; border: none; color: #a0a4ba; cursor: pointer; font-size: 18px; padding: 4px 8px;">👁</button>
                <button id="btn-copy-waiting-room-id" class="btn ghost small">コピー</button>
              </div>
              <p class="waiting-hint">このルームIDを参加者に共有してください</p>
            </div>
            
            <div class="waiting-players-section">
              <h2 class="waiting-section-title">参加者 (<span id="waiting-players-count">1</span>人)</h2>
              <div id="waiting-players-list" class="waiting-players-list">
                <!-- JSで参加者を描画 -->
              </div>
            </div>
            
            <div class="waiting-actions">
              <button id="open-rulebook-from-waiting" class="btn ghost">ルールブック</button>
              <button id="btn-rules-settings" class="btn secondary" style="display: none;">ルール設定</button>
              <button id="btn-start-game-from-waiting" class="btn primary" disabled>
                ゲーム開始 (最低3人必要)
              </button>
              <button id="btn-leave-room" class="btn ghost">ルームを退出</button>
            </div>
          </div>
        </div>
      </section>

      <!-- メイン GM 画面 -->
      <section id="main-screen" class="screen">
        <div class="main-layout">
          <!-- ④ プレーヤー表示 -->
          <aside class="panel players-panel">
            <h2>プレイヤー</h2>
            <div id="players-list" class="players-list">
              <!-- JSでプレイヤーを描画 -->
            </div>
          </aside>

          <!-- 中央メインエリア -->
          <section class="panel center-panel">
            <!-- ① 状態表示 -->
            <div class="status-bar">
              <div class="status-main">
                <div class="status-main-item">
                  <span class="status-main-label">ラウンド</span>
                  <span id="status-turn" class="status-main-value">1 / 5</span>
                </div>
                <div class="status-main-item">
                  <span class="status-main-label">進行状況</span>
                  <span id="status-stars" class="status-main-stars">☆☆☆☆☆</span>
                </div>
                <div class="status-main-item">
                  <span class="status-main-label">ステージ</span>
                  <span id="status-stage" class="status-main-value status-stage-value">未選出</span>
                </div>
                <div class="status-main-item" id="status-wolf-cost-item" style="display: none;">
                  <span class="status-main-label">妨害コスト</span>
                  <span id="status-wolf-cost" class="status-main-value">-</span>
                </div>
                <div class="status-main-item" id="status-doctor-punch-item" style="display: none;">
                  <span class="status-main-label">神拳発動</span>
                  <span id="status-doctor-punch" class="status-main-value">-</span>
                </div>
              </div>
              <button id="main-options-btn" class="icon-button" title="オプション">
                ⚙
              </button>
            </div>
            
            <!-- プレイ映像用 16:9 透明エリア（背景レイヤー） -->
            <div class="play-video-wrapper">
              <div class="play-video-area">
              </div>
            </div>

            <!-- UI要素（前面レイヤー） -->
            <div class="center-ui-content">
              <!-- ログエリアは削除（レイアウトは維持） -->
              <div class="play-video-under-space"></div>
            </div>
          </section>

          <!-- ② 操作パネル -->
          <aside class="panel control-panel">
            <div class="control-group">
              <button id="btn-open-stage-roulette" class="btn primary wide">
                ステージ選出開始
              </button>
            </div>
            <div class="control-group">
              <button id="btn-success" class="btn success wide">
                成功
              </button>
              <button id="btn-fail" class="btn danger wide">
                失敗
              </button>
            </div>
          </aside>
        </div>

        <!-- フッターのクレジット -->
        <footer class="app-footer">
          <p>
            本ツールは非公式ファンツールです。Hypergryph / Yostar とは一切関係ありません。
          </p>
        </footer>
      </section>

      <!-- 参加者画面（最小UI：役職ボタンのみ / 画面表示エリアなし） -->
      <section id="participant-screen" class="screen">
        <div class="participant-layout">
          <!-- 操作パネル（GM画面と同じサイズ・位置、2カラム構造） -->
          <aside class="panel participant-panel">
            <!-- 一列目（左カラム）：役職名、コスト -->
            <div class="participant-column participant-column-left">
              <div class="control-group">
            <!-- 役職表示 -->
            <div id="participant-role-display" class="participant-role-display" style="display: none;">
              <span class="participant-role-label">役職:</span>
              <span id="participant-role-text" class="participant-role-text">-</span>
            </div>

            <!-- コスト表示（人狼のみ） -->
            <div id="participant-cost-display" class="participant-cost-display" style="display: none;">
              <span class="participant-cost-label">Cost:</span>
              <span id="participant-cost-value" class="participant-cost-value">-</span>
                </div>
              </div>
            </div>

            <!-- 二列目（右カラム）：ルールブック、ログを表示 -->
            <div class="participant-column participant-column-right">
              <div class="control-group">
              <button id="open-rulebook-from-participant" class="btn ghost wide">
                ルールブック
              </button>
            </div>
              <div class="control-group">
                <button id="open-log-from-participant" class="btn ghost wide">
                  ログを表示
                </button>
          </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- ステージルーレットポップアップ -->
      <div id="stage-roulette-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>ステージルーレット</h2>
          <p class="modal-subtitle">
            設定された範囲からランダムにステージを選出します。
          </p>
          <div id="stage-roulette-items" class="roulette-list">
            <!-- JSで候補を表示 -->
          </div>
        </div>
      </div>

      <!-- 妨害選択ポップアップ（人狼用） -->
      <div id="wolf-action-select-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>人狼妨害選択</h2>
          <p class="modal-subtitle">
            発動する妨害を選択してください（コスト: <span id="wolf-cost-display">-</span>）
          </p>
          <div id="wolf-action-list" class="wolf-action-list">
            <!-- JSで妨害リストを表示 -->
          </div>
          <div class="modal-actions">
            <button data-close-modal="wolf-action-select-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>


      <!-- 統一アナウンスポップアップ -->
      <div id="announcement-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2 id="announcement-title">アナウンス</h2>
          <p id="announcement-subtitle" class="announcement-subtitle" style="display: none;"></p>
          <div id="announcement-actions" class="modal-actions" style="display: none; justify-content: center; margin-top: 20px;">
            <button id="announcement-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- ドクター神拳選択ポップアップ（ゲストUI用） -->
      <div id="doctor-punch-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>ドクター神拳</h2>
          <p class="modal-subtitle" style="margin: 20px 0; color: #a0a4ba;">
            失敗を打ち消して成功判定にしますか？
          </p>
          <div class="modal-actions" style="justify-content: center; gap: 12px; margin-top: 24px;">
            <button id="doctor-punch-modal-use" class="btn info">ドクター神拳</button>
            <button id="doctor-punch-modal-skip" class="btn ghost">使用しない</button>
          </div>
        </div>
      </div>

      <!-- 会議フェーズモーダル（GM専用） -->
      <div id="discussion-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>会議フェーズ</h2>
          <div style="text-align: center; margin: 24px 0;">
            <div id="discussion-timer" style="font-size: 48px; font-weight: 700; color: #8be6c3; letter-spacing: 0.1em; margin-bottom: 12px;">
              05:00
            </div>
            <p style="color: #a0a4ba; font-size: 14px; margin: 0;">
              タイマーが0になると自動で次のフェーズに進みます
            </p>
          </div>
          <div class="modal-actions" style="justify-content: center; gap: 12px;">
            <button id="discussion-extend" class="btn secondary">2分延長</button>
            <button id="discussion-end" class="btn primary">終了</button>
          </div>
        </div>
      </div>

      <!-- ゲーム開始時の極秘命令ポップアップ -->
      <div id="mission-brief-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="width: auto; max-width: 1200px;">
          <h2 style="text-align: center; margin-bottom: 24px; color: #f5f5f7;">極秘命令</h2>
          <div id="mission-brief-content" class="mission-brief-content" style="padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; line-height: 1.8; color: #e0e0e0; font-size: 16px; white-space: pre-line; text-align: center;">
          </div>
          <div class="modal-actions" style="justify-content: center; margin-top: 24px;">
            <button id="mission-brief-close" class="btn primary">了解</button>
          </div>
        </div>
      </div>

      <!-- ルールブックモーダル -->
      <div id="rulebook-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide" style="max-width: 1600px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>ルールブック</h2>
            <button data-close-modal="rulebook-modal" class="btn ghost small">閉じる</button>
          </div>
          <div class="rulebook-pages" style="min-height: 500px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; overflow-y: hidden;">
            <div id="rulebook-page-1" class="rulebook-page" style="display: none;">
              <h3>このゲームの目標と勝利条件</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                このゲームはロドス陣営(市民側)の妨害を行うレユニオン(人狼)を探しながら、協力して作戦に挑む「協力・推理型」人狼ゲームです。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>ロドス陣営の勝利条件：</strong><br />
                ・過半数のラウンドで攻略に成功すること（3ラウンドゲーム：2ラウンド成功、5ラウンドゲーム：3ラウンド成功）<br />
                ・過半数のラウンドで攻略に失敗したのち、最終フェーズ（逆転指名）でレユニオンを投票により指名すること
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>レユニオンの勝利条件：</strong><br />
                ・ドクターのターンを失敗させること（ドクターが失敗し、ドクター神拳も使用できなかった場合、即座にレユニオン勝利）<br />
                ・過半数のラウンドで攻略を失敗に導き、最終フェーズ（逆転指名）で投票により指名されないこと
              </p>
            </div>
            <div id="rulebook-page-2" class="rulebook-page" style="display: none;">
              <h3>このゲームの流れ</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                <strong>1. ゲーム開始</strong><br />
                役職がランダムに配布されます。各プレイヤーは自分の役職を確認します。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>2. ラウンド進行</strong><br />
                各ラウンドは以下の流れで進行します：<br />
                ① ステージ選出（GMがルーレットで選出）<br />
                ② ターン開始（「○○のターンです」）<br />
                ③ レユニオン妨害フェーズ（レユニオンが妨害を選択可能）<br />
                ④ ステージ攻略（プレイヤーが実際にステージをプレイ）<br />
                ⑤ 成功/失敗判定（GMが判定）<br />
                ⑥ ドクター神拳フェーズ（失敗時のみ、ドクターが神拳を使用可能）<br />
                ⑦ 次のプレイヤーへ（全員のターンが一巡するまで繰り返し）
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>3. ラウンド終了</strong><br />
                一度でもターン失敗すると、そのラウンドは失敗（×）となります。次のラウンドへ進みます。<br />
                ただし、1ラウンドに1度だけドクター神拳による失敗の打ち消しが可能です。ドクター神拳を使用した場合、その失敗はなかったことになり、ラウンドは成功（○）として記録されます。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>4. 会議フェーズ</strong><br />
                ラウンド終了後、5分間の会議フェーズが開始されます。この間にプレイヤーは自由に話し合いができます。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>5. 最終フェーズ（逆転指名）</strong><br />
                ラウンド失敗（×）が過半数以上になった場合、10分の会議フェーズの後、最終フェーズ（逆転指名）が開始されます。全プレイヤー（オペレーター・ドクター・レユニオン）がレユニオンを指名し、全員が投票した時点で、一番被投票数の多いプレイヤーが1人だけ（同率1位ではない）の場合、そのプレイヤーがレユニオンかどうかで勝敗が決まります。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>6. ゲーム終了</strong><br />
                勝利条件を満たした時点でゲームが終了し、勝敗が決定します。過半数がラウンド数を取得した時点で勝敗が決まるため、全ラウンド終了を待つ必要はありません。
              </p>
            </div>
            <div id="rulebook-page-3" class="rulebook-page" style="display: none;">
              <h3>ステージ攻略と判定について</h3>
              <div style="margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <span style="font-size: 24px;">🎲</span>
                  <strong style="color: #f5f5f7;">ステージ選出</strong>
                </div>
                <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                  GMが設定したステージ範囲から、ルーレットでランダムにステージが選出されます。
                </p>
              </div>
              <div style="margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <span style="font-size: 24px;">⚔️</span>
                  <strong style="color: #f5f5f7;">ステージ攻略</strong>
                </div>
                <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                  選出されたステージを、そのターンのプレイヤーが実際にプレイします。人狼の妨害が適用されている場合は、その制約に従ってプレイする必要があります。
                </p>
              </div>
              <div style="margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <span style="font-size: 24px;">✓</span>
                  <strong style="color: #f5f5f7;">成功/失敗判定</strong>
                </div>
                <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                  ステージをクリアできた場合は成功（○）、クリアできなかった場合は失敗（×）となります。判定はGMが行います。<br />
                  <strong style="color: #ff6464;">重要：一度でもターン失敗すると、そのラウンドは失敗（×）となります。次のラウンドへ進みます。</strong>
                </p>
              </div>
              <div style="margin-top: 16px; padding: 16px; background: rgba(139, 230, 195, 0.1); border-radius: 8px; border-left: 4px solid #8be6c3;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 24px;">👊</span>
                  <strong style="color: #8be6c3;">ドクター神拳</strong>
                </div>
                <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                  失敗した場合、ドクターが「ドクター神拳」を使用することで、失敗をなかったことにできます。<br />
                  <span style="color: #8be6c3;">※ 1ゲーム中に5回まで使用可能</span><br />
                  <span style="color: #8be6c3;">※ 1ラウンドに1度だけ使用可能（そのラウンドの最初の失敗のみ打ち消し可能）</span>
                </p>
              </div>
            </div>
            <div id="rulebook-page-4" class="rulebook-page" style="display: none;">
              <h3>役職について</h3>
              <p style="color: #a0a4ba; line-height: 1.8; margin-bottom: 16px;">
                このゲームには3つの役職があります：
              </p>
              <div style="display: grid; gap: 12px; margin-top: 16px;">
                <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">👤</span>
                    <strong style="color: #f5f5f7;">オペレーター</strong>
                  </div>
                  <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                    通常のプレイヤーです。ステージを攻略することを目標とします。特別な能力はありませんが、協力してステージをクリアしていきます。
                  </p>
                </div>
                <div style="padding: 16px; background: rgba(139, 230, 195, 0.1); border-radius: 8px; border: 1px solid rgba(139, 230, 195, 0.3);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">👨‍⚕️</span>
                    <strong style="color: #8be6c3;">ドクター</strong>
                  </div>
                  <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                    失敗したステージを「ドクター神拳」で打ち消すことができます。<br />
                    <span style="color: #8be6c3;">※ 1ゲーム中に5回まで使用可能</span><br />
                    <span style="color: #8be6c3;">※ 1ラウンドに1度だけ使用可能（そのラウンドの最初の失敗のみ打ち消し可能）</span><br />
                    ロドス陣営の勝利を目指します。
                  </p>
                </div>
                <div style="padding: 16px; background: rgba(255, 100, 100, 0.1); border-radius: 8px; border: 1px solid rgba(255, 100, 100, 0.3);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">🐺</span>
                    <strong style="color: #ff6464;">レユニオン（人狼）</strong>
                  </div>
                  <p style="color: #a0a4ba; line-height: 1.8; margin-left: 32px;">
                    ステージ攻略を妨害する役職です。各ターンの開始時に妨害を選択できます。<br />
                    <span style="color: #ff6464;">※ 妨害コストの合計が初期コスト（デフォルト100）を超えない範囲で使用可能</span><br />
                    レユニオン陣営の勝利を目指します。
                  </p>
                </div>
              </div>
            </div>
            <div id="rulebook-page-5" class="rulebook-page" style="display: none;">
              <h3>役職ごとのルールと行動指針（オペレーター）</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                <strong>オペレーターの役割</strong><br />
                オペレーターは、ステージを攻略して成功（○）を増やすことが主な役割です。レユニオンの妨害に注意しながら、協力してステージをクリアしていきます。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>行動指針</strong><br />
                ・レユニオンの妨害内容を確認し、その制約に従ってステージをプレイする<br />
                ・他のプレイヤーと協力し、情報を共有する<br />
                ・会議フェーズでは、レユニオンの可能性を探るために議論に参加する<br />
                ・ステージ攻略時は、妨害の制約を守りながら最善を尽くす
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>注意事項</strong><br />
                ・レユニオンの妨害は必ず守る必要があります<br />
                ・妨害の内容を無視したプレイは禁止です<br />
                ・<strong style="color: #ff6464;">指示厨禁止！攻略に関する内容は聞かれたときだけ答えよう！</strong>
              </p>
            </div>
            <div id="rulebook-page-6" class="rulebook-page" style="display: none;">
              <h3>役職ごとのルールと行動指針（ドクター）</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                <strong>ドクターの役割</strong><br />
                ドクターは、失敗したステージを「ドクター神拳」で打ち消すことができます。1ゲーム中に5回まで使用可能です。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>ドクター神拳の使用</strong><br />
                ・失敗したステージに対して、ドクターが「ドクター神拳」を使用できます<br />
                ・使用すると、その失敗はなかったことになり、成功（○）として記録されます<br />
                ・1ゲーム中に5回まで使用可能です<br />
                ・<strong style="color: #8be6c3;">1ラウンドに1度だけ使用可能（そのラウンドの最初の失敗のみ打ち消し可能）</strong><br />
                ・「背水の陣」の妨害が適用されている場合は、そのラウンド中は使用できません
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>行動指針</strong><br />
                ・重要なラウンドや、失敗が致命的になる場面で使用を検討する<br />
                ・残り回数を考慮しながら、戦略的に使用する<br />
                ・会議フェーズでは、神拳の使用状況を考慮した議論を行う
              </p>
            </div>
            <div id="rulebook-page-7" class="rulebook-page" style="display: none;">
              <h3>役職ごとのルールと行動指針（レユニオン）</h3>
              <div style="margin-top: 16px; padding: 16px; background: rgba(255, 100, 100, 0.1); border-radius: 8px; border-left: 4px solid #ff6464;">
                <strong style="color: #ff6464; display: block; margin-bottom: 8px;">🐺 レユニオン（人狼）の役割</strong>
                <p style="color: #a0a4ba; line-height: 1.8;">
                  ステージ攻略を妨害することで、失敗（×）を増やすことが主な役割です。各ターンの開始時に妨害を選択できます。
                </p>
              </div>
              <div style="margin-top: 16px;">
                <strong style="color: #f5f5f7; display: block; margin-bottom: 8px;">妨害の選択</strong>
                <ul style="color: #a0a4ba; line-height: 1.8; margin-left: 20px;">
                  <li>各ターンの開始時に、妨害を選択するかどうかを決定します</li>
                  <li>妨害を選択する場合は、コストを消費して妨害を発動します</li>
                  <li>妨害にはコストが設定されており、コストの合計が初期コスト（デフォルト100）を超えない範囲で使用できます</li>
                  <li>妨害を選択しないことも可能です</li>
                </ul>
              </div>
              <div style="margin-top: 16px;">
                <strong style="color: #f5f5f7; display: block; margin-bottom: 8px;">妨害の種類</strong>
                <table style="width: 100%; border-collapse: collapse; margin-top: 8px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; overflow: hidden;">
                  <thead>
                    <tr style="background: rgba(255, 100, 100, 0.2);">
                      <th style="padding: 8px; text-align: left; color: #f5f5f7; border-bottom: 1px solid rgba(255,255,255,0.1);">妨害名</th>
                      <th style="padding: 8px; text-align: right; color: #f5f5f7; border-bottom: 1px solid rgba(255,255,255,0.1);">コスト</th>
                      <th style="padding: 8px; text-align: left; color: #f5f5f7; border-bottom: 1px solid rgba(255,255,255,0.1);">効果</th>
                    </tr>
                  </thead>
                  <tbody id="rulebook-wolf-actions-body">
                    <!-- JSでルーム設定(wolfActions)を反映して描画 -->
                  </tbody>
                </table>
              </div>
              <div style="margin-top: 16px;">
                <strong style="color: #f5f5f7; display: block; margin-bottom: 8px;">行動指針</strong>
                <ul style="color: #a0a4ba; line-height: 1.8; margin-left: 20px;">
                  <li>コストを考慮しながら、効果的な妨害を選択する</li>
                  <li>重要なラウンドや、成功が致命的になる場面で妨害を使用する</li>
                  <li>会議フェーズでは、人狼であることを隠しながら議論に参加する</li>
                </ul>
              </div>
            </div>
            <div id="rulebook-page-8" class="rulebook-page" style="display: none;">
              <h3>最終フェーズ（逆転指名）について</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                <strong>最終フェーズの条件</strong><br />
                ラウンド失敗（×）が過半数以上になった場合、最終フェーズ（逆転指名）に進みます。
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>最終フェーズの流れ</strong><br />
                1. 10分の会議フェーズ（最終フェーズ前の会議）<br />
                2. 最終フェーズ（逆転指名）<br />
                　・全プレイヤー（オペレーター・ドクター・レユニオン）がレユニオンを指名します<br />
                　・全員が投票した時点で、一番被投票数の多いプレイヤーが1人だけ（同率1位ではない）の場合、そのプレイヤーがレユニオンかどうかで勝敗が決まります
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>最終フェーズの勝敗判定</strong><br />
                ・最多得票者が1人だけの場合：<br />
                　- レユニオンが指名された場合：ロドス陣営勝利（逆転勝利）<br />
                　- レユニオン以外が指名された場合：レユニオン勝利<br />
                ・同率1位の場合はレユニオン勝利
              </p>
            </div>
            <div id="rulebook-page-9" class="rulebook-page" style="display: none;">
              <h3>禁止行為</h3>
              <p style="color: #a0a4ba; line-height: 1.8;">
                以下の行為は禁止されています：
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>ゲーム進行に関する禁止行為</strong><br />
                ・レユニオンの妨害内容を無視したプレイ<br />
                ・妨害の制約に違反したステージ攻略<br />
                ・GMの判定に従わない行為<br />
                ・ゲームの進行を故意に妨害する行為
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>コミュニケーションに関する禁止行為</strong><br />
                ・役職を直接的に暴露する行為（ただし、推測や議論は可）<br />
                ・ゲーム外の情報を使用する行為<br />
                ・他のプレイヤーを脅迫・中傷する行為<br />
                ・<strong style="color: #ff6464;">指示厨禁止！攻略に関する内容は聞かれたときだけ答えよう！</strong>
              </p>
              <p style="color: #a0a4ba; line-height: 1.8; margin-top: 12px;">
                <strong>その他の禁止行為</strong><br />
                ・チート行為や不正な操作<br />
                ・ゲームの公平性を損なう行為<br />
                ・GMの指示に従わない行為
              </p>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <button id="rulebook-prev" class="btn ghost" disabled>前へ</button>
            <span id="rulebook-page-indicator" style="color: #a0a4ba;">1 / 9</span>
            <button id="rulebook-next" class="btn ghost">次へ</button>
          </div>
        </div>
      </div>

      <!-- GM向け：職業ルーレットポップアップ（ランダム職業使用禁止用） -->
      <div id="job-roulette-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>職業ルーレット</h2>
          <p class="modal-subtitle">
            ランダム職業使用禁止：使用禁止になる職業を選出します。
          </p>
          <div id="job-roulette-items" class="roulette-list">
            <!-- JSで候補を表示 -->
          </div>
          <div class="modal-actions">
            <button id="job-roulette-start" class="btn primary">
              ルーレット開始
            </button>
            <button data-close-modal="job-roulette-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 人狼妨害の使用確認（手番開始フェーズ） -->
      <div id="wolf-decision-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>人狼妨害</h2>
          <p class="modal-subtitle">
            手番のはじめに妨害を使用しますか？
          </p>
          <div class="modal-actions">
            <button id="wolf-decision-use" class="btn warning">使用する</button>
            <button id="wolf-decision-skip" class="btn ghost">使用しない</button>
          </div>
        </div>
      </div>


      <!-- GM向け：全員の役職一覧 -->
      <div id="gm-roles-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <h2>役職一覧（GM専用）</h2>
          <p class="modal-subtitle">ゲーム開始時に割り当てられた役職を周知します。</p>
          <div id="gm-roles-list" class="role-confirmation-list"></div>
          <div class="modal-actions">
            <button id="gm-roles-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- オプションポップアップ -->
      <div id="options-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>オプション</h2>
            <button id="open-rulebook-from-options" class="btn ghost small">ルールブック</button>
          </div>
          <section class="options-section">
            <h3>サウンド</h3>
            <label class="toggle">
              <input type="checkbox" id="opt-sound" name="opt-sound" />
              <span>効果音を有効にする (デフォルトOFF)</span>
            </label>
          </section>

          <button id="opt-back-home" class="btn ghost small">
            ホーム画面に戻る
          </button>

          <section class="options-section">
            <h3>利用規約</h3>
            <p>
              詳細な注意事項は
              <button id="opt-open-tos" class="link-button">
                利用規約ページ
              </button>
              をご確認ください。
            </p>
          </section>

          <div class="modal-actions">
            <button id="opt-save" class="btn primary">保存</button>
            <button data-close-modal="options-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 利用規約ポップアップ -->
      <div id="tos-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide scrollable">
          <h2>利用規約 / 免責事項</h2>
          <div class="tos-body">
            <p>
              本ツールは個人が制作した<strong>非公式ファンツール</strong>です。<br />
              Hypergryph / Yostar とは一切関係ありません。
            </p>
            <ul>
              <li>
                本ツールの利用は<strong>自己責任</strong>でお願いいたします。利用により発生したいかなる損害についても制作者は責任を負いません。
              </li>
              <li>
                ゲーム画面・キャラクター・名称等の権利は各権利者に帰属します。
              </li>
              <li>
                本ツールは画像・テキストなどのデータ取得は行っていませんが、データの取り扱いには十分ご注意ください。
              </li>
              <li>
                配信・動画での使用は自由ですが、公式と誤認されない形でご利用ください。
              </li>
            </ul>
            <p>
              詳細なガイドラインや二次創作ポリシーについては、各公式サイトの規約をご確認ください。
            </p>
          </div>
          <div class="modal-actions">
            <button data-close-modal="tos-modal" class="btn primary">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- ルール設定モーダル（GM専用） -->
      <div id="rules-settings-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide scroll-shell">
          <h2>ルール設定</h2>
          <div class="modal-body-scroll">
          <section class="options-section">
            <div class="options-row">
              <label>
                  対象ステージ範囲 (章) ※ラウンドごとに設定
                  <div id="rules-stage-ranges" style="display: flex; flex-direction: column; gap: 8px; margin-top: 6px;">
                    <!-- JSでラウンドごとの章レンジを描画 -->
                </div>
                  <p style="font-size: 11px; color: #a0a4ba; margin-top: 6px;">
                    例）1ラウンド目: 0〜1章 / 2ラウンド目: 1〜2章
                  </p>
              </label>
            </div>

            <div class="options-row">
              <label>
                人狼の初期コスト
                <input
                  type="number"
                  id="rules-wolf-initial-cost"
                  name="rules-wolf-initial-cost"
                  min="1"
                  max="200"
                  value="100"
                  style="width: 100%; padding: 8px; margin-top: 4px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,7,18,0.8); color: #f5f5f7; font-size: 14px;"
                />
                <p style="font-size: 11px; color: #a0a4ba; margin-top: 4px;">人狼が使用できる妨害の総コストです（デフォルト: 100）</p>
              </label>
            </div>

            <div class="options-row">
              <label>
                  人狼妨害（編集可能: タイトル / 表示文言 / コスト）
                  <div id="rules-wolf-actions-editor" style="display: flex; flex-direction: column; gap: 10px; margin-top: 6px;">
                    <!-- JSで妨害エディタを描画 -->
                  </div>
              </label>
            </div>
          </section>
          </div>

          <div class="modal-actions">
            <button id="rules-save" class="btn primary">保存</button>
            <button data-close-modal="rules-settings-modal" class="btn ghost">
              閉じる
            </button>
          </div>
        </div>
      </div>

      <!-- 役職確認モーダル（ゲーム開始前） -->
      <div id="role-confirmation-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content wide">
          <h2>役職確認</h2>
          <p class="modal-subtitle">
            役職がランダムに割り当てられました。確認してからゲームを開始してください。
          </p>
          <div id="role-confirmation-list" class="role-confirmation-list">
            <!-- JSで役職リストを生成 -->
          </div>
          <div class="modal-actions">
            <button id="role-confirmation-start" class="btn primary">ゲーム開始</button>
          </div>
        </div>
      </div>

      <!-- 自分の役職確認モーダル（ゲーム開始時） -->
      <div id="self-role-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2>あなたの役職</h2>
          <p id="self-role-text" class="result-summary" style="text-align: center; font-size: 20px; margin-top: 12px;">
            （取得中…）
          </p>
          <p id="self-role-waiting" class="result-summary hidden" style="text-align:center; margin-top: 10px; color:#a0a4ba;">
            開始待機中…
          </p>
          <div class="modal-actions">
            <button id="self-role-ok" class="btn primary">OK</button>
          </div>
        </div>
      </div>

      <!-- 勝敗結果ポップアップ -->
      <div id="result-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <h2 id="result-title">結果</h2>
          <p id="result-summary" class="result-summary"></p>
          <div id="result-extra" class="result-extra"></div>
          <div id="result-roles" class="result-roles"></div>
          <div class="modal-actions">
            <button id="result-return-lobby" class="btn primary">ロビーに戻る</button>
            <button id="result-disband" class="btn ghost">解散してホームに戻る</button>
          </div>
        </div>
      </div>

      <!-- 勝利画面（専用画面） -->
      <section id="victory-screen" class="screen">
        <div class="victory-layout">
          <div class="victory-content">
            <h1 id="victory-title" class="victory-title"></h1>
            <div id="victory-story" class="victory-story"></div>
            <div id="victory-vote-results" class="victory-vote-results"></div>
            <div id="victory-roles" class="victory-roles"></div>
            <div class="victory-actions">
              <button id="victory-return-lobby" class="btn primary">ロビーに戻る</button>
              <button id="victory-disband" class="btn ghost">解散してホームに戻る</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Firebase設定とモジュール（ES Modules） -->
    <script type="module" src="./firebase-config.js"></script>
    <script type="module" src="./firebase-auth.js"></script>
    <script type="module" src="./firebase-db.js"></script>
    <script type="module" src="./firebase-sync.js"></script>
    
    <!-- メインロジック -->
    <script type="module" src="./main.js"></script>
  </body>
  </html>

